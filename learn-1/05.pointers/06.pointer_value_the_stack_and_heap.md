# Stack and Heap
Trong Go (Golang), Ä‘á»ƒ hiá»ƒu vá» **stack** vÃ  **heap** trong ngá»¯ cáº£nh cá»§a **pointer**, ta cáº§n náº¯m rÃµ cÃ¡ch Go quáº£n lÃ½ bá»™ nhá»› vÃ  cÃ¡ch cÃ¡c biáº¿n (bao gá»“m pointer) Ä‘Æ°á»£c lÆ°u trá»¯. DÆ°á»›i Ä‘Ã¢y lÃ  giáº£i thÃ­ch chi tiáº¿t, dá»… hiá»ƒu, vÃ  táº­p trung vÃ o Go:

---

### 1. **Stack vÃ  Heap lÃ  gÃ¬?**

- **Stack**:
  - LÃ  vÃ¹ng bá»™ nhá»› Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ lÆ°u trá»¯ cÃ¡c biáº¿n **cá»¥c bá»™** (local variables) trong má»™t hÃ m.
  - Stack hoáº¡t Ä‘á»™ng theo cÆ¡ cháº¿ **LIFO** (Last In, First Out), nghÄ©a lÃ  biáº¿n Ä‘Æ°á»£c táº¡o sau sáº½ Ä‘Æ°á»£c giáº£i phÃ³ng trÆ°á»›c khi hÃ m káº¿t thÃºc.
  - Stack cÃ³ kÃ­ch thÆ°á»›c cá»‘ Ä‘á»‹nh (nhá») vÃ  Ä‘Æ°á»£c quáº£n lÃ½ tá»± Ä‘á»™ng bá»Ÿi runtime cá»§a Go.
  - CÃ¡c biáº¿n trÃªn stack thÆ°á»ng cÃ³ vÃ²ng Ä‘á»i ngáº¯n, chá»‰ tá»“n táº¡i trong pháº¡m vi cá»§a hÃ m gá»i.

- **Heap**:
  - LÃ  vÃ¹ng bá»™ nhá»› lá»›n hÆ¡n, dÃ¹ng Ä‘á»ƒ lÆ°u trá»¯ cÃ¡c biáº¿n cÃ³ **vÃ²ng Ä‘á»i Ä‘á»™ng** (dynamic lifetime), nghÄ©a lÃ  khÃ´ng bá»‹ giá»›i háº¡n bá»Ÿi pháº¡m vi cá»§a má»™t hÃ m.
  - CÃ¡c biáº¿n trÃªn heap Ä‘Æ°á»£c quáº£n lÃ½ bá»Ÿi **Garbage Collector (GC)** cá»§a Go, giÃºp tá»± Ä‘á»™ng giáº£i phÃ³ng bá»™ nhá»› khi biáº¿n khÃ´ng cÃ²n Ä‘Æ°á»£c tham chiáº¿u.
  - Heap phÃ¹ há»£p cho cÃ¡c dá»¯ liá»‡u cáº§n tá»“n táº¡i lÃ¢u hÆ¡n hoáº·c Ä‘Æ°á»£c chia sáº» giá»¯a nhiá»u hÃ m.

---

### 2. **Pointer trong Go**

- Trong Go, **pointer** lÃ  má»™t biáº¿n lÆ°u trá»¯ **Ä‘á»‹a chá»‰ bá»™ nhá»›** cá»§a má»™t giÃ¡ trá»‹ khÃ¡c. CÃº phÃ¡p:
  ```go
  var x int = 10
  var p *int = &x // p lÃ  pointer, trá» Ä‘áº¿n Ä‘á»‹a chá»‰ cá»§a x
  ```
- Pointer cÃ³ thá»ƒ trá» Ä‘áº¿n dá»¯ liá»‡u trÃªn **stack** hoáº·c **heap**, tÃ¹y thuá»™c vÃ o cÃ¡ch biáº¿n Ä‘Æ°á»£c cáº¥p phÃ¡t.

---

### 3. **Stack vÃ  Heap vá»›i Pointer trong Go**

Trong Go, viá»‡c má»™t biáº¿n (hoáº·c dá»¯ liá»‡u mÃ  pointer trá» Ä‘áº¿n) Ä‘Æ°á»£c lÆ°u trÃªn **stack** hay **heap** phá»¥ thuá»™c vÃ o cÃ¡ch biáº¿n Ä‘Æ°á»£c sá»­ dá»¥ng vÃ  quyáº¿t Ä‘á»‹nh cá»§a **escape analysis** (phÃ¢n tÃ­ch thoÃ¡t) trong trÃ¬nh biÃªn dá»‹ch Go.

#### **3.1. Stack vá»›i Pointer**
- Khi má»™t biáº¿n cá»¥c bá»™ Ä‘Æ°á»£c táº¡o trong má»™t hÃ m vÃ  khÃ´ng "thoÃ¡t" ra khá»i pháº¡m vi cá»§a hÃ m (tá»©c lÃ  khÃ´ng Ä‘Æ°á»£c tráº£ vá» hoáº·c lÆ°u trá»¯ á»Ÿ nÆ¡i khÃ¡c), nÃ³ thÆ°á»ng Ä‘Æ°á»£c cáº¥p phÃ¡t trÃªn **stack**.
- Pointer trá» Ä‘áº¿n biáº¿n trÃªn stack chá»‰ hoáº¡t Ä‘á»™ng trong pháº¡m vi cá»§a hÃ m Ä‘Ã³. Náº¿u hÃ m káº¿t thÃºc, stack frame cá»§a hÃ m bá»‹ xÃ³a, vÃ  dá»¯ liá»‡u mÃ  pointer trá» Ä‘áº¿n sáº½ khÃ´ng cÃ²n há»£p lá»‡.

**VÃ­ dá»¥:**
```go
package main

import "fmt"

func main() {
    x := 10
    p := &x // p trá» Ä‘áº¿n x, x Ä‘Æ°á»£c cáº¥p phÃ¡t trÃªn stack
    fmt.Println(*p) // In ra 10
}
```
- Trong vÃ­ dá»¥ nÃ y, `x` lÃ  biáº¿n cá»¥c bá»™, Ä‘Æ°á»£c lÆ°u trÃªn **stack**. Pointer `p` trá» Ä‘áº¿n Ä‘á»‹a chá»‰ cá»§a `x`. Khi hÃ m `main` káº¿t thÃºc, `x` vÃ  `p` bá»‹ xÃ³a khá»i stack.

#### **3.2. Heap vá»›i Pointer**
- Náº¿u má»™t biáº¿n "thoÃ¡t" ra khá»i pháº¡m vi cá»§a hÃ m (vÃ­ dá»¥: Ä‘Æ°á»£c tráº£ vá», lÆ°u vÃ o má»™t biáº¿n toÃ n cá»¥c, hoáº·c Ä‘Æ°á»£c gÃ¡n vÃ o má»™t cáº¥u trÃºc dá»¯ liá»‡u nhÆ° slice/map), Go sáº½ cáº¥p phÃ¡t biáº¿n Ä‘Ã³ trÃªn **heap**.
- Pointer trá» Ä‘áº¿n dá»¯ liá»‡u trÃªn heap cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng á»Ÿ báº¥t ká»³ Ä‘Ã¢u, miá»…n lÃ  dá»¯ liá»‡u váº«n cÃ²n Ä‘Æ°á»£c tham chiáº¿u.

**VÃ­ dá»¥:**
```go
package main

import "fmt"

func createPointer() *int {
    x := 10
    return &x // x sáº½ Ä‘Æ°á»£c cáº¥p phÃ¡t trÃªn heap vÃ¬ nÃ³ thoÃ¡t ra khá»i hÃ m
}

func main() {
    p := createPointer()
    fmt.Println(*p) // In ra 10
}
```
- Trong vÃ­ dá»¥ nÃ y, `x` ban Ä‘áº§u lÃ  biáº¿n cá»¥c bá»™, nhÆ°ng vÃ¬ Ä‘á»‹a chá»‰ cá»§a nÃ³ (`&x`) Ä‘Æ°á»£c tráº£ vá», trÃ¬nh biÃªn dá»‹ch Go thá»±c hiá»‡n **escape analysis** vÃ  quyáº¿t Ä‘á»‹nh cáº¥p phÃ¡t `x` trÃªn **heap**. Äiá»u nÃ y Ä‘áº£m báº£o ráº±ng `x` váº«n tá»“n táº¡i sau khi hÃ m `createPointer` káº¿t thÃºc.

#### **Escape Analysis**
- Go sá»­ dá»¥ng **escape analysis** Ä‘á»ƒ quyáº¿t Ä‘á»‹nh nÆ¡i cáº¥p phÃ¡t bá»™ nhá»›:
  - Náº¿u má»™t biáº¿n chá»‰ Ä‘Æ°á»£c sá»­ dá»¥ng trong pháº¡m vi hÃ m, nÃ³ Ä‘Æ°á»£c cáº¥p trÃªn **stack**.
  - Náº¿u biáº¿n thoÃ¡t ra khá»i pháº¡m vi (vÃ­ dá»¥: tráº£ vá» pointer, lÆ°u vÃ o slice/map, hoáº·c gÃ¡n vÃ o má»™t struct), nÃ³ Ä‘Æ°á»£c cáº¥p trÃªn **heap**.
- Báº¡n cÃ³ thá»ƒ kiá»ƒm tra escape analysis báº±ng lá»‡nh:
  ```bash
  go build -gcflags="-m" file.go
  ```
  Output sáº½ cho biáº¿t biáº¿n nÃ o "escapes to heap".

**VÃ­ dá»¥ escape analysis:**
```go
package main

func foo() *int {
    x := 42
    return &x // x escapes to heap
}

func bar() {
    x := 42
    y := &x // x váº«n trÃªn stack vÃ¬ khÃ´ng thoÃ¡t
    _ = y
}
```
- Trong `foo`, `x` Ä‘Æ°á»£c cáº¥p trÃªn heap vÃ¬ Ä‘á»‹a chá»‰ cá»§a nÃ³ Ä‘Æ°á»£c tráº£ vá».
- Trong `bar`, `x` Ä‘Æ°á»£c cáº¥p trÃªn stack vÃ¬ nÃ³ khÃ´ng thoÃ¡t ra ngoÃ i.

---

### 4. **Khi nÃ o dÃ¹ng Stack, khi nÃ o dÃ¹ng Heap?**

- **Stack**:
  - DÃ¹ng cho cÃ¡c biáº¿n cá»¥c bá»™ vá»›i vÃ²ng Ä‘á»i ngáº¯n, khÃ´ng cáº§n tá»“n táº¡i ngoÃ i hÃ m.
  - Hiá»‡u quáº£ hÆ¡n vÃ¬ khÃ´ng cáº§n quáº£n lÃ½ bá»Ÿi Garbage Collector.
  - VÃ­ dá»¥: Biáº¿n táº¡m trong hÃ m, cÃ¡c giÃ¡ trá»‹ khÃ´ng tráº£ vá».

- **Heap**:
  - DÃ¹ng cho cÃ¡c biáº¿n cáº§n tá»“n táº¡i lÃ¢u hÆ¡n hoáº·c Ä‘Æ°á»£c chia sáº» giá»¯a nhiá»u hÃ m.
  - PhÃ¹ há»£p cho dá»¯ liá»‡u Ä‘á»™ng (slice, map, struct lá»›n) hoáº·c khi tráº£ vá» pointer.
  - Tuy nhiÃªn, heap cÃ³ chi **chi phÃ­** cao hÆ¡n vÃ¬ cáº§n Garbage Collection.

---

### 5. **LÆ°u Ã½ khi lÃ m viá»‡c vá»›i Pointer**

- **TrÃ¡nh tráº£ vá» pointer Ä‘áº¿n biáº¿n stack**: Náº¿u báº¡n tráº£ vá» Ä‘á»‹a chá»‰ cá»§a má»™t biáº¿n cá»¥c bá»™, nhÆ°ng nÃ³ khÃ´ng thoÃ¡t (do lá»—i logic), chÆ°Æ¡ng trÃ¬nh cÃ³ thá»ƒ gáº·p lá»—i **undefined behavior** (hÃ nh vi khÃ´ng xÃ¡c Ä‘á»‹nh).
- **Hiá»ƒu Garbage Collection**: Dá»¯ liá»‡u trÃªn heap sáº½ Ä‘Æ°á»£c giáº£i phÃ³ng khi khÃ´ng cÃ²n pointer nÃ o trá» Ä‘áº¿n nÃ³. Náº¿u giá»¯ pointer khÃ´ng cáº§n thiáº¿t, báº¡n cÃ³ thá»ƒ gÃ¢y **memory leak**.
- **Sá»­ dá»¥ng pointer há»£p lÃ½**: Trong Go, báº¡n thÆ°á»ng khÃ´ng cáº§n dÃ¹ng pointer nhiá»u vÃ¬ Go cÃ³ cÆ¡ cháº¿ truyá»n tham trá»‹ (pass-by-value) vÃ  cÃ¡c kiá»ƒu dá»¯ liá»‡u nhÆ° slice, map Ä‘Ã£ lÃ  tham chiáº¿u ngáº§m.

**VÃ­ dá»¥ lá»—i tráº£ vá» pointer Ä‘áº¿n stack (sai):**
```go
func badPointer() *int {
    x := 10
    return &x // Lá»—i: x trÃªn stack, sáº½ bá»‹ xÃ³a khi hÃ m káº¿t thÃºc
}
```

---

### 6. **TÃ³m táº¯t**

- **Stack**: LÆ°u biáº¿n cá»¥c bá»™, vÃ²ng Ä‘á»i ngáº¯n, quáº£n lÃ½ tá»± Ä‘á»™ng, hiá»‡u quáº£. Pointer trá» Ä‘áº¿n stack chá»‰ há»£p lá»‡ trong hÃ m.
- **Heap**: LÆ°u biáº¿n thoÃ¡t khá»i hÃ m, vÃ²ng Ä‘á»i dÃ i, quáº£n lÃ½ bá»Ÿi GC. Pointer trá» Ä‘áº¿n heap cÃ³ thá»ƒ dÃ¹ng á»Ÿ nhiá»u nÆ¡i.
- **Escape Analysis**: Go tá»± Ä‘á»™ng quyáº¿t Ä‘á»‹nh cáº¥p phÃ¡t stack hay heap dá»±a trÃªn cÃ¡ch sá»­ dá»¥ng biáº¿n.
- **Thá»±c hÃ nh**: DÃ¹ng pointer cáº©n tháº­n, trÃ¡nh tráº£ vá» Ä‘á»‹a chá»‰ cá»§a biáº¿n stack, vÃ  kiá»ƒm tra escape analysis Ä‘á»ƒ tá»‘i Æ°u hiá»‡u nÄƒng.

Náº¿u báº¡n muá»‘n Ä‘i sÃ¢u hÆ¡n vÃ o má»™t vÃ­ dá»¥ cá»¥ thá»ƒ hoáº·c cáº§n giáº£i thÃ­ch thÃªm vá» escape analysis, cá»© há»i nhÃ©, bro! ğŸ˜

# Escape Analysis
ChÃ o bro! Cáº£m Æ¡n vÃ¬ cÃ¢u há»i hay, tiáº¿p ná»‘i chá»§ Ä‘á» vá» **stack** vÃ  **heap** trong Go, giá» mÃ¬nh sáº½ giáº£i thÃ­ch chi tiáº¿t vá» **escape analysis** trong Golang, má»™t khÃ¡i niá»‡m quan trá»ng liÃªn quan Ä‘áº¿n viá»‡c quyáº¿t Ä‘á»‹nh nÆ¡i cáº¥p phÃ¡t bá»™ nhá»› (stack hay heap). MÃ¬nh sáº½ giáº£i thÃ­ch dá»… hiá»ƒu, táº­p trung vÃ o Go, vÃ  cÃ³ vÃ­ dá»¥ minh há»a nhÃ©!

---

### 1. **Escape Analysis lÃ  gÃ¬?**

**Escape analysis** lÃ  má»™t ká»¹ thuáº­t Ä‘Æ°á»£c trÃ¬nh biÃªn dá»‹ch Go sá»­ dá»¥ng trong quÃ¡ trÃ¬nh biÃªn dá»‹ch Ä‘á»ƒ phÃ¢n tÃ­ch xem má»™t biáº¿n cÃ³ "thoÃ¡t" (escape) ra khá»i pháº¡m vi cá»§a hÃ m hay khÃ´ng. Dá»±a trÃªn phÃ¢n tÃ­ch nÃ y, Go quyáº¿t Ä‘á»‹nh cáº¥p phÃ¡t biáº¿n Ä‘Ã³ trÃªn **stack** hay **heap**:

- **Stack**: Náº¿u biáº¿n chá»‰ Ä‘Æ°á»£c sá»­ dá»¥ng trong pháº¡m vi hÃ m (khÃ´ng thoÃ¡t), nÃ³ Ä‘Æ°á»£c cáº¥p phÃ¡t trÃªn stack. Äiá»u nÃ y nhanh vÃ  hiá»‡u quáº£ vÃ¬ stack Ä‘Æ°á»£c quáº£n lÃ½ tá»± Ä‘á»™ng vÃ  khÃ´ng cáº§n Garbage Collector (GC).
- **Heap**: Náº¿u biáº¿n thoÃ¡t ra khá»i pháº¡m vi hÃ m (vÃ­ dá»¥: Ä‘Æ°á»£c tráº£ vá», lÆ°u vÃ o biáº¿n toÃ n cá»¥c, hoáº·c gÃ¡n vÃ o má»™t cáº¥u trÃºc dá»¯ liá»‡u nhÆ° slice/map), nÃ³ Ä‘Æ°á»£c cáº¥p phÃ¡t trÃªn heap. Heap cháº­m hÆ¡n vÃ¬ cáº§n GC quáº£n lÃ½, nhÆ°ng phÃ¹ há»£p cho dá»¯ liá»‡u cÃ³ vÃ²ng Ä‘á»i dÃ i.

Escape analysis lÃ  má»™t pháº§n cá»§a **tá»‘i Æ°u hÃ³a bá»™ nhá»›** trong Go, giÃºp giáº£m thiá»ƒu viá»‡c sá»­ dá»¥ng heap khÃ´ng cáº§n thiáº¿t, tá»« Ä‘Ã³ cáº£i thiá»‡n hiá»‡u suáº¥t chÆ°Æ¡ng trÃ¬nh.

---

### 2. **Táº¡i sao Escape Analysis quan trá»ng?**

- **Hiá»‡u suáº¥t**: Cáº¥p phÃ¡t trÃªn stack nhanh hÆ¡n vÃ  khÃ´ng táº¡o gÃ¡nh náº·ng cho GC. Escape analysis giÃºp Go tá»‘i Æ°u báº±ng cÃ¡ch Æ°u tiÃªn stack khi cÃ³ thá»ƒ.
- **Quáº£n lÃ½ bá»™ nhá»›**: Biáº¿n trÃªn heap cáº§n GC Ä‘á»ƒ giáº£i phÃ³ng, trong khi biáº¿n trÃªn stack tá»± Ä‘á»™ng Ä‘Æ°á»£c xÃ³a khi hÃ m káº¿t thÃºc. Escape analysis giáº£m sá»‘ lÆ°á»£ng biáº¿n trÃªn heap, giÃºp GC lÃ m viá»‡c Ã­t hÆ¡n.
- **Tá»‘i Æ°u code**: Hiá»ƒu escape analysis giÃºp báº¡n viáº¿t code hiá»‡u quáº£ hÆ¡n, trÃ¡nh cÃ¡c trÆ°á»ng há»£p biáº¿n khÃ´ng cáº§n thiáº¿t bá»‹ Ä‘áº©y lÃªn heap.

---

### 3. **Escape Analysis hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o?**

TrÃ¬nh biÃªn dá»‹ch Go phÃ¢n tÃ­ch code Ä‘á»ƒ xÃ¡c Ä‘á»‹nh **vÃ²ng Ä‘á»i** cá»§a má»™t biáº¿n. Má»™t biáº¿n Ä‘Æ°á»£c coi lÃ  "thoÃ¡t" náº¿u nÃ³:

1. **ÄÆ°á»£c tráº£ vá»** tá»« hÃ m (qua return hoáº·c thÃ´ng qua pointer).
2. **ÄÆ°á»£c lÆ°u trá»¯** vÃ o má»™t biáº¿n toÃ n cá»¥c hoáº·c má»™t cáº¥u trÃºc dá»¯ liá»‡u (nhÆ° slice, map, hoáº·c struct) mÃ  váº«n tá»“n táº¡i sau khi hÃ m káº¿t thÃºc.
3. **ÄÆ°á»£c truyá»n** vÃ o má»™t hÃ m khÃ¡c dÆ°á»›i dáº¡ng tham chiáº¿u (pointer) vÃ  Ä‘Æ°á»£c sá»­ dá»¥ng ngoÃ i pháº¡m vi hÃ m ban Ä‘áº§u.
4. **CÃ³ kÃ­ch thÆ°á»›c khÃ´ng xÃ¡c Ä‘á»‹nh** táº¡i thá»i Ä‘iá»ƒm biÃªn dá»‹ch (vÃ­ dá»¥: slice hoáº·c interface cÃ³ thá»ƒ phÃ¡t triá»ƒn Ä‘á»™ng).

Náº¿u biáº¿n thoÃ¡t, Go sáº½ cáº¥p phÃ¡t nÃ³ trÃªn heap. NgÆ°á»£c láº¡i, náº¿u biáº¿n chá»‰ Ä‘Æ°á»£c sá»­ dá»¥ng trong pháº¡m vi hÃ m, nÃ³ á»Ÿ trÃªn stack.

---

### 4. **VÃ­ dá»¥ minh há»a Escape Analysis**

DÆ°á»›i Ä‘Ã¢y lÃ  má»™t sá»‘ vÃ­ dá»¥ Ä‘á»ƒ báº¡n tháº¥y cÃ¡ch escape analysis hoáº¡t Ä‘á»™ng trong Go:

#### **VÃ­ dá»¥ 1: Biáº¿n khÃ´ng thoÃ¡t (Stack)**
```go
package main

import "fmt"

func noEscape() {
    x := 10
    p := &x // p trá» Ä‘áº¿n x
    fmt.Println(*p) // Chá»‰ sá»­ dá»¥ng trong hÃ m
}

func main() {
    noEscape()
}
```
- Trong hÃ m `noEscape`, biáº¿n `x` vÃ  pointer `p` chá»‰ Ä‘Æ°á»£c sá»­ dá»¥ng trong pháº¡m vi hÃ m. Escape analysis xÃ¡c Ä‘á»‹nh ráº±ng `x` **khÃ´ng thoÃ¡t**, nÃªn `x` Ä‘Æ°á»£c cáº¥p phÃ¡t trÃªn **stack**.
- Khi hÃ m káº¿t thÃºc, stack frame cá»§a `noEscape` bá»‹ xÃ³a, vÃ  `x` biáº¿n máº¥t.

#### **VÃ­ dá»¥ 2: Biáº¿n thoÃ¡t (Heap)**
```go
package main

import "fmt"

func escape() *int {
    x := 10
    return &x // Tráº£ vá» Ä‘á»‹a chá»‰ cá»§a x
}

func main() {
    p := escape()
    fmt.Println(*p) // In ra 10
}
```
- Trong hÃ m `escape`, `x` ban Ä‘áº§u lÃ  biáº¿n cá»¥c bá»™, nhÆ°ng vÃ¬ Ä‘á»‹a chá»‰ cá»§a nÃ³ (`&x`) Ä‘Æ°á»£c tráº£ vá», escape analysis xÃ¡c Ä‘á»‹nh ráº±ng `x` **thoÃ¡t** ra khá»i hÃ m.
- Go cáº¥p phÃ¡t `x` trÃªn **heap** Ä‘á»ƒ Ä‘áº£m báº£o `x` váº«n tá»“n táº¡i sau khi hÃ m `escape` káº¿t thÃºc.
- Biáº¿n trÃªn heap sáº½ Ä‘Æ°á»£c GC giáº£i phÃ³ng khi khÃ´ng cÃ²n pointer nÃ o trá» Ä‘áº¿n nÃ³ (vÃ­ dá»¥: khi `p` ra khá»i pháº¡m vi).

#### **VÃ­ dá»¥ 3: ThoÃ¡t do gÃ¡n vÃ o slice**
```go
package main

import "fmt"

func appendToSlice() []int {
    x := 42
    s := []int{x} // x Ä‘Æ°á»£c gÃ¡n vÃ o slice
    return s      // slice Ä‘Æ°á»£c tráº£ vá»
}

func main() {
    s := appendToSlice()
    fmt.Println(s) // In ra [42]
}
```
- Trong hÃ m `appendToSlice`, `x` Ä‘Æ°á»£c gÃ¡n vÃ o slice `s`. VÃ¬ `s` Ä‘Æ°á»£c tráº£ vá» vÃ  slice lÃ  má»™t cáº¥u trÃºc dá»¯ liá»‡u Ä‘á»™ng, `x` **thoÃ¡t** vÃ  Ä‘Æ°á»£c cáº¥p phÃ¡t trÃªn **heap**.
- LÃ½ do lÃ  slice cÃ³ thá»ƒ Ä‘Æ°á»£c má»Ÿ rá»™ng hoáº·c truyá»n Ä‘i nÆ¡i khÃ¡c, nÃªn Go cáº§n Ä‘áº£m báº£o dá»¯ liá»‡u cá»§a `x` tá»“n táº¡i ngoÃ i pháº¡m vi hÃ m.

#### **VÃ­ dá»¥ 4: Interface gÃ¢y thoÃ¡t**
```go
package main

import "fmt"

func useInterface() interface{} {
    x := 42
    return x // Tráº£ vá» dÆ°á»›i dáº¡ng interface{}
}

func main() {
    result := useInterface()
    fmt.Println(result) // In ra 42
}
```
- Khi `x` Ä‘Æ°á»£c tráº£ vá» dÆ°á»›i dáº¡ng `interface{}`, Go khÃ´ng thá»ƒ xÃ¡c Ä‘á»‹nh kiá»ƒu cá»¥ thá»ƒ cá»§a nÃ³ táº¡i thá»i Ä‘iá»ƒm biÃªn dá»‹ch. Do Ä‘Ã³, `x` **thoÃ¡t** vÃ  Ä‘Æ°á»£c cáº¥p phÃ¡t trÃªn **heap**.
- Äiá»u nÃ y thÆ°á»ng xáº£y ra vá»›i cÃ¡c kiá»ƒu dá»¯ liá»‡u Ä‘á»™ng nhÆ° interface hoáº·c khi sá»­ dá»¥ng reflection.

---

### 5. **Kiá»ƒm tra Escape Analysis**

Báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng cá» `-gcflags="-m"` khi biÃªn dá»‹ch Ä‘á»ƒ xem escape analysis cá»§a Go hoáº¡t Ä‘á»™ng tháº¿ nÃ o:

```bash
go build -gcflags="-m" file.go
```

**VÃ­ dá»¥ output cho hÃ m `escape` á»Ÿ trÃªn:**
```bash
# command-line-arguments
./main.go:6:6: x escapes to heap
./main.go:5:9: moved to heap: x
```
- DÃ²ng `x escapes to heap` cho biáº¿t `x` Ä‘Æ°á»£c cáº¥p phÃ¡t trÃªn heap vÃ¬ nÃ³ thoÃ¡t ra khá»i hÃ m.

**VÃ­ dá»¥ output cho hÃ m `noEscape`:**
```bash
# command-line-arguments
./main.go:6:6: p does not escape
```
- DÃ²ng `p does not escape` cho biáº¿t `x` vÃ  `p` á»Ÿ trÃªn stack vÃ¬ chÃºng khÃ´ng thoÃ¡t.

---

### 6. **Máº¹o Ä‘á»ƒ giáº£m Escape (Tá»‘i Æ°u hÃ³a)**

Dá»±a trÃªn kinh nghiá»‡m cá»§a báº¡n vá»›i Go (nhÆ° báº¡n Ä‘Ã£ há»c qua cÃ¡c khÃ³a trÃªn KodeKloud vÃ  Ä‘ang nghiÃªn cá»©u Kubernetes operator, struct, interface), mÃ¬nh biáº¿t báº¡n quan tÃ¢m Ä‘áº¿n viá»‡c viáº¿t code hiá»‡u quáº£. DÆ°á»›i Ä‘Ã¢y lÃ  vÃ i máº¹o Ä‘á»ƒ giáº£m viá»‡c biáº¿n thoÃ¡t lÃªn heap:

1. **TrÃ¡nh tráº£ vá» pointer khÃ´ng cáº§n thiáº¿t**:
   - Náº¿u báº¡n chá»‰ cáº§n tráº£ vá» giÃ¡ trá»‹, hÃ£y dÃ¹ng giÃ¡ trá»‹ thay vÃ¬ pointer.
   ```go
   // KÃ©m tá»‘i Æ°u
   func getPtr() *int {
       x := 10
       return &x // ThoÃ¡t lÃªn heap
   }

   // Tá»‘t hÆ¡n
   func getValue() int {
       x := 10
       return x // á» trÃªn stack
   }
   ```

2. **Sá»­ dá»¥ng giÃ¡ trá»‹ thay vÃ¬ pointer trong struct nhá»**:
   - Náº¿u struct nhá», hÃ£y nhÃºng giÃ¡ trá»‹ thay vÃ¬ pointer Ä‘á»ƒ trÃ¡nh cáº¥p phÃ¡t heap.
   ```go
   type MyStruct struct {
       value int
   }

   // Tá»‘t hÆ¡n
   s := MyStruct{value: 10}

   // KÃ©m tá»‘i Æ°u
   p := &MyStruct{value: 10} // CÃ³ thá»ƒ gÃ¢y thoÃ¡t
   ```

3. **Háº¡n cháº¿ sá»­ dá»¥ng interface khi khÃ´ng cáº§n**:
   - Interface thÆ°á»ng gÃ¢y thoÃ¡t vÃ¬ Go khÃ´ng thá»ƒ xÃ¡c Ä‘á»‹nh kiá»ƒu cá»¥ thá»ƒ táº¡i thá»i Ä‘iá»ƒm biÃªn dá»‹ch.
   ```go
   // GÃ¢y thoÃ¡t
   func returnInterface() interface{} {
       return 42
   }

   // Tá»‘t hÆ¡n
   func returnInt() int {
       return 42
   }
   ```

4. **Hiá»ƒu cÃ¡ch slice vÃ  map hoáº¡t Ä‘á»™ng**:
   - Khi thÃªm dá»¯ liá»‡u vÃ o slice hoáº·c map, dá»¯ liá»‡u cÃ³ thá»ƒ thoÃ¡t náº¿u slice/map Ä‘Æ°á»£c tráº£ vá» hoáº·c lÆ°u trá»¯ lÃ¢u dÃ i.
   - Náº¿u slice/map chá»‰ dÃ¹ng táº¡m thá»i trong hÃ m, hÃ£y Ä‘áº£m báº£o nÃ³ khÃ´ng thoÃ¡t.

5. **Kiá»ƒm tra vá»›i `-gcflags="-m"`**:
   - ThÆ°á»ng xuyÃªn kiá»ƒm tra escape analysis Ä‘á»ƒ hiá»ƒu code cá»§a báº¡n cáº¥p phÃ¡t bá»™ nhá»› tháº¿ nÃ o vÃ  tá»‘i Æ°u náº¿u cáº§n.

---

### 87. **TÃ³m táº¯t**

- **Escape Analysis**: LÃ  ká»¹ thuáº­t cá»§a Go Ä‘á»ƒ quyáº¿t Ä‘á»‹nh cáº¥p phÃ¡t biáº¿n trÃªn stack hay heap dá»±a trÃªn viá»‡c biáº¿n cÃ³ thoÃ¡t ra khá»i hÃ m hay khÃ´ng.
- **Stack**: Biáº¿n khÃ´ng thoÃ¡t, vÃ²ng Ä‘á»i ngáº¯n, hiá»‡u quáº£.
- **Heap**: Biáº¿n thoÃ¡t (tráº£ vá», lÆ°u vÃ o slice/map, dÃ¹ng trong interface), cáº§n GC.
- **Kiá»ƒm tra**: DÃ¹ng `-gcflags="-m"` Ä‘á»ƒ xem biáº¿n nÃ o thoÃ¡t.
- **Tá»‘i Æ°u**: TrÃ¡nh tráº£ vá» pointer khÃ´ng cáº§n thiáº¿t, háº¡n cháº¿ interface, vÃ  kiá»ƒm tra escape analysis Ä‘á»ƒ viáº¿t code hiá»‡u quáº£.

Náº¿u báº¡n muá»‘n mÃ¬nh phÃ¢n tÃ­ch thÃªm má»™t Ä‘oáº¡n code cá»¥ thá»ƒ hoáº·c giáº£i thÃ­ch cÃ¡ch tá»‘i Æ°u escape analysis trong dá»± Ã¡n cá»§a báº¡n (nhÆ° KubeNotifyPlus hoáº·c operator), cá»© nÃ³i nhÃ©, bro! ğŸ˜


# Example #1: 
```go
package main

import (
	"fmt"
)

func main() {
	a := 1
	fmt.Println(a)
}

/* Escape to the heap
variable shared between main() and Println()

moved to heap
variable moved to the heap
*/
```

Output: `go run -gcflags -m test.go`
```bash
# command-line-arguments
./test.go:9:13: inlining call to fmt.Println
./test.go:9:13: ... argument does not escape
./test.go:9:14: a escapes to heap
1
```

# Example #2
```go
package main

import (
	"fmt"
)

func main() {
	a := 1
	fmt.Println(&a)
}

/* Escape to the heap
variable shared between main() and Println()

moved to heap
variable moved to the heap
*/
```

Output: `go run -gcflags -m test.go`
```bash
# command-line-arguments
./test.go:9:13: inlining call to fmt.Println
./test.go:8:2: moved to heap: a
./test.go:9:13: ... argument does not escape
0xc00011a040
```