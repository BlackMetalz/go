# Wait Group introduction

# First code snippet:
```go
package main

import (
    "fmt"
    "runtime"
)

func main() {
    // func main can be considered as a goroutine. So if you don't define any goroutines, 
    // the main function will be executed in the main goroutine. And count will be 1.
    fmt.Println("OS\t\t", runtime.GOOS)
    fmt.Println("ARCH\t", runtime.GOARCH)
    fmt.Println("NumCPU\t", runtime.NumCPU())
    fmt.Println("NumGoroutine\t", runtime.NumGoroutine()) // NumGoroutine     1. This is the main goroutine
    fmt.Println("Version", runtime.Version())
    go foo() // This will not print anything
    bar()
    fmt.Println("NumCPU\t", runtime.NumCPU())
    fmt.Println("NumGoroutine\t", runtime.NumGoroutine()) // NumGoroutine     2
}

func foo() {
    for i := 0; i < 10; i++ {
        fmt.Println("foo ", i)
    }
}

func bar() {
    for i := 0; i < 10; i++ {
        fmt.Println("bar ", i)
    }
}
```

Output: You should understand this!
```
OS               linux
ARCH     amd64
NumCPU   24
NumGoroutine     1
Version go1.23.6
bar  0
bar  1
bar  2
bar  3
bar  4
bar  5
bar  6
bar  7
bar  8
bar  9
NumCPU   24
NumGoroutine     2
```

# Second example that contains wait group
```go
package main

import (
	"fmt"
	"runtime"
	"sync"
)

// This program demonstrates the use of goroutines in Go.
var wg sync.WaitGroup 

func main() {
    // func main can be considered as a goroutine. So if you don't define any goroutines, 
    // the main function will be executed in the main goroutine. And count will be 1.
    fmt.Println("OS\t\t", runtime.GOOS)
    fmt.Println("ARCH\t", runtime.GOARCH)
    fmt.Println("NumCPU\t", runtime.NumCPU())
    fmt.Println("NumGoroutine\t", runtime.NumGoroutine()) // NumGoroutine     1. This is the main goroutine
    fmt.Println("Version", runtime.Version())

    wg.Add(1) // Add 1 to the WaitGroup counter

    go foo() // This will not print anything
    bar()
    fmt.Println("NumCPU\t", runtime.NumCPU())
    fmt.Println("NumGoroutine\t", runtime.NumGoroutine()) // NumGoroutine     2

    wg.Wait() // Wait for the goroutine to finish
    // This will block until the WaitGroup counter is decremented to 0
    // The main goroutine will wait for the foo goroutine to finish before exiting
    // If you don't call wg.Done() in the foo function, the program will hang
    // because the main goroutine will be waiting for the foo goroutine to finish
    // and the foo goroutine will never finish because it is waiting for the main goroutine to finish
}

func foo() {
    for i := 0; i < 10; i++ {
        fmt.Println("foo ", i)
    }
    wg.Done() // Decrement the WaitGroup counter
}

func bar() {
    for i := 0; i < 10; i++ {
        fmt.Println("bar ", i)
    }
}
```

Output:
```
OS               linux
ARCH     amd64
NumCPU   24
NumGoroutine     1
Version go1.23.6
bar  0
bar  1
bar  2
bar  3
bar  4
bar  5
bar  6
bar  7
bar  8
bar  9
NumCPU   24
NumGoroutine     2
foo  0
foo  1
foo  2
foo  3
foo  4
foo  5
foo  6
foo  7
foo  8
foo  9
```

# Explain
ƒêo·∫°n code b·∫°n ƒë∆∞a ra l√† m·ªôt v√≠ d·ª• ƒëi·ªÉn h√¨nh v·ªÅ vi·ªác s·ª≠ d·ª•ng **goroutines** v√† **WaitGroup** trong Go ƒë·ªÉ qu·∫£n l√Ω ƒë·ªìng th·ªùi (concurrency). M√¨nh s·∫Ω gi·∫£i th√≠ch chi ti·∫øt, √°nh x·∫° v·ªõi m·ªôt v√≠ d·ª• th·ª±c t·∫ø, v√† ki·ªÉm tra xem c√°ch hi·ªÉu c·ªßa b·∫°n c√≥ v·∫•n ƒë·ªÅ g√¨ kh√¥ng. Let‚Äôs dive in!

---

### **1. T·ªïng quan v·ªÅ ƒëo·∫°n code**
ƒêo·∫°n code n√†y minh h·ªça c√°ch s·ª≠ d·ª•ng **goroutines** (m·ªôt c∆° ch·∫ø concurrency nh·∫π trong Go) ƒë·ªÉ ch·∫°y ƒë·ªìng th·ªùi hai h√†m `foo` v√† `bar`, ƒë·ªìng th·ªùi s·ª≠ d·ª•ng `sync.WaitGroup` ƒë·ªÉ ƒë·∫£m b·∫£o ch∆∞∆°ng tr√¨nh kh√¥ng k·∫øt th√∫c tr∆∞·ªõc khi c√°c goroutine ho√†n th√†nh. D∆∞·ªõi ƒë√¢y l√† c√°c th√†nh ph·∫ßn ch√≠nh:

- **Goroutines**: L√† c√°c "lu·ªìng" nh·∫π ƒë∆∞·ª£c Go runtime qu·∫£n l√Ω, kh√¥ng ph·∫£i thread c·ªßa h·ªá ƒëi·ªÅu h√†nh. Trong code, `go foo()` t·∫°o m·ªôt goroutine m·ªõi ƒë·ªÉ ch·∫°y h√†m `foo` song song v·ªõi `main` goroutine.
- **sync.WaitGroup**: ƒê∆∞·ª£c d√πng ƒë·ªÉ ƒë·ªìng b·ªô h√≥a, ƒë·∫£m b·∫£o c√°c goroutine ho√†n th√†nh tr∆∞·ªõc khi ch∆∞∆°ng tr√¨nh tho√°t.
- **runtime**: Package cung c·∫•p th√¥ng tin v·ªÅ h·ªá th·ªëng nh∆∞ h·ªá ƒëi·ªÅu h√†nh (`GOOS`), ki·∫øn tr√∫c (`GOARCH`), s·ªë CPU (`NumCPU`), s·ªë goroutine ƒëang ch·∫°y (`NumGoroutine`), v√† phi√™n b·∫£n Go (`Version`).

---

### **2. Ph√¢n t√≠ch chi ti·∫øt ƒëo·∫°n code**

#### **C√°c th√†nh ph·∫ßn ch√≠nh trong code**
1. **Bi·∫øn to√†n c·ª•c `wg sync.WaitGroup`**:
   - ƒê√¢y l√† m·ªôt bi·∫øn to√†n c·ª•c ki·ªÉu `sync.WaitGroup`, ƒë∆∞·ª£c d√πng ƒë·ªÉ theo d√µi s·ªë l∆∞·ª£ng goroutine c·∫ßn ƒë·ª£i.
   - `wg.Add(1)` tƒÉng b·ªô ƒë·∫øm l√™n 1, nghƒ©a l√† b√°o cho WaitGroup r·∫±ng c√≥ 1 goroutine c·∫ßn ch·ªù.
   - `wg.Done()` gi·∫£m b·ªô ƒë·∫øm ƒëi 1, b√°o r·∫±ng goroutine ƒë√£ ho√†n th√†nh.
   - `wg.Wait()` ch·∫∑n (block) cho ƒë·∫øn khi b·ªô ƒë·∫øm v·ªÅ 0, t·ª©c l√† t·∫•t c·∫£ goroutine ƒë√£ g·ªçi `Done`.

2. **H√†m `main`**:
   - In th√¥ng tin h·ªá th·ªëng: h·ªá ƒëi·ªÅu h√†nh, ki·∫øn tr√∫c, s·ªë CPU, s·ªë goroutine hi·ªán t·∫°i (ban ƒë·∫ßu l√† 1 v√¨ ch·ªâ c√≥ goroutine c·ªßa `main`).
   - G·ªçi `wg.Add(1)` ƒë·ªÉ b√°o r·∫±ng s·∫Ω c√≥ 1 goroutine c·∫ßn ch·ªù (·ªü ƒë√¢y l√† `foo`).
   - `go foo()`: T·∫°o m·ªôt goroutine m·ªõi ƒë·ªÉ ch·∫°y h√†m `foo` ƒë·ªìng th·ªùi.
   - G·ªçi `bar()` tr·ª±c ti·∫øp (kh√¥ng d√πng `go`, n√™n ch·∫°y tu·∫ßn t·ª± trong goroutine c·ªßa `main`).
   - In l·∫°i s·ªë CPU v√† s·ªë goroutine (l√∫c n√†y l√† 2 v√¨ c√≥ `main` v√† `foo`).
   - `wg.Wait()`: Ch·∫∑n `main` cho ƒë·∫øn khi `foo` g·ªçi `wg.Done()`.

3. **H√†m `foo`**:
   - In chu·ªói "foo" k√®m s·ªë t·ª´ 0 ƒë·∫øn 9.
   - G·ªçi `wg.Done()` ƒë·ªÉ b√°o r·∫±ng goroutine n√†y ƒë√£ ho√†n th√†nh.

4. **H√†m `bar`**:
   - In chu·ªói "bar" k√®m s·ªë t·ª´ 0 ƒë·∫øn 9.
   - Kh√¥ng li√™n quan ƒë·∫øn WaitGroup v√¨ n√≥ ch·∫°y trong goroutine c·ªßa `main`.

#### **L∆∞u √Ω v·ªÅ concurrency**
- `go foo()` ch·∫°y **foo** trong m·ªôt goroutine ri√™ng, n√™n n√≥ ch·∫°y song song v·ªõi `bar()` (ch·∫°y trong goroutine c·ªßa `main`).
- V√¨ concurrency kh√¥ng ƒë·∫£m b·∫£o th·ª© t·ª± th·ª±c thi, output c·ªßa `foo` v√† `bar` c√≥ th·ªÉ xen k·∫Ω nhau (v√≠ d·ª•: "foo 0", "bar 0", "foo 1", "bar 1", ...).
- N·∫øu kh√¥ng c√≥ `wg.Wait()`, ch∆∞∆°ng tr√¨nh c√≥ th·ªÉ k·∫øt th√∫c tr∆∞·ªõc khi `foo` ho√†n th√†nh, d·∫´n ƒë·∫øn vi·ªác kh√¥ng th·∫•y output c·ªßa `foo`.

---

### **3. √Ånh x·∫° v·ªõi v√≠ d·ª• th·ª±c t·∫ø**
ƒê·ªÉ d·ªÖ hi·ªÉu, h√£y t∆∞·ªüng t∆∞·ª£ng b·∫°n l√† m·ªôt qu·∫£n l√Ω nh√† h√†ng v√† c·∫ßn ƒëi·ªÅu ph·ªëi c√¥ng vi·ªác trong b·∫øp:

- **Goroutines**:
  - Goroutine gi·ªëng nh∆∞ c√°c ƒë·∫ßu b·∫øp trong b·∫øp, m·ªói ng∆∞·ªùi l√†m m·ªôt c√¥ng vi·ªác ri√™ng (nh∆∞ n·∫•u s√∫p, n∆∞·ªõng b√°nh).
  - `main` goroutine l√† b·∫°n (qu·∫£n l√Ω), ƒëi·ªÅu ph·ªëi t·ªïng th·ªÉ.
  - `go foo()` gi·ªëng nh∆∞ b·∫°n giao cho m·ªôt ƒë·∫ßu b·∫øp (goroutine m·ªõi) l√†m m√≥n s√∫p, ƒë·ªÉ b·∫°n c√≥ th·ªÉ l√†m vi·ªác kh√°c song song.
  - `bar()` l√† c√¥ng vi·ªác b·∫°n t·ª± l√†m (nh∆∞ chu·∫©n b·ªã nguy√™n li·ªáu), kh√¥ng giao cho ai.

- **WaitGroup**:
  - WaitGroup gi·ªëng nh∆∞ m·ªôt danh s√°ch c√¥ng vi·ªác c·∫ßn ho√†n th√†nh tr∆∞·ªõc khi ƒë√≥ng c·ª≠a nh√† h√†ng.
  - `wg.Add(1)`: B·∫°n ghi v√†o danh s√°ch r·∫±ng m√≥n s√∫p c·∫ßn ƒë∆∞·ª£c ho√†n th√†nh.
  - `wg.Done()`: ƒê·∫ßu b·∫øp b√°o r·∫±ng m√≥n s√∫p ƒë√£ xong, b·∫°n g·∫°ch b·ªè kh·ªèi danh s√°ch.
  - `wg.Wait()`: B·∫°n ƒë·ª©ng ƒë·ª£i ·ªü c·ª≠a, kh√¥ng ƒë√≥ng c·ª≠a nh√† h√†ng cho ƒë·∫øn khi t·∫•t c·∫£ m√≥n ƒÉn trong danh s√°ch (m√≥n s√∫p) ƒë∆∞·ª£c ho√†n th√†nh.

- **T√¨nh hu·ªëng th·ª±c t·∫ø**:
  - B·∫°n giao cho ƒë·∫ßu b·∫øp l√†m m√≥n s√∫p (`go foo()`), c√≤n b·∫°n chu·∫©n b·ªã nguy√™n li·ªáu (`bar()`).
  - Hai vi·ªác n√†y di·ªÖn ra song song (concurrency).
  - B·∫°n kh√¥ng r·ªùi nh√† h√†ng (`wg.Wait()`) cho ƒë·∫øn khi ƒë·∫ßu b·∫øp b√°o r·∫±ng m√≥n s√∫p ƒë√£ xong (`wg.Done()`).
  - N·∫øu b·∫°n kh√¥ng ƒë·ª£i (`wg.Wait()`), b·∫°n c√≥ th·ªÉ ƒë√≥ng c·ª≠a nh√† h√†ng tr∆∞·ªõc khi m√≥n s√∫p ho√†n th√†nh, d·∫´n ƒë·∫øn m√≥n s√∫p kh√¥ng ƒë∆∞·ª£c ph·ª•c v·ª• (output c·ªßa `foo` kh√¥ng xu·∫•t hi·ªán).

---

### **4. Ki·ªÉm tra c√°ch hi·ªÉu c·ªßa b·∫°n**
C√°ch gi·∫£i th√≠ch c·ªßa b·∫°n kh√° t·ªët, nh∆∞ng m√¨nh s·∫Ω ch·ªâ ra m·ªôt s·ªë ƒëi·ªÉm ƒë·ªÉ l√†m r√µ ho·∫∑c b·ªï sung:

1. **V·ªÅ `wg.Add(1)`**:
   - B·∫°n n√≥i ƒë√∫ng r·∫±ng `wg.Add(1)` b√°o r·∫±ng c√≥ 1 goroutine c·∫ßn ƒë·ª£i. Tuy nhi√™n, c·∫ßn nh·∫•n m·∫°nh r·∫±ng s·ªë n√†y ph·∫£i kh·ªõp v·ªõi s·ªë l·∫ßn g·ªçi `wg.Done()`. N·∫øu g·ªçi `wg.Add(2)` nh∆∞ng ch·ªâ c√≥ 1 `wg.Done()`, ch∆∞∆°ng tr√¨nh s·∫Ω treo (deadlock) v√¨ WaitGroup ƒë·ª£i m√£i kh√¥ng ƒë·ªß.

2. **V·ªÅ `go foo()`**:
   - B·∫°n hi·ªÉu ƒë√∫ng r·∫±ng `go foo()` t·∫°o m·ªôt goroutine ƒë·ªÉ ch·∫°y `foo` ƒë·ªìng th·ªùi. Nh∆∞ng c·∫ßn l∆∞u √Ω r·∫±ng n·∫øu kh√¥ng c√≥ `wg.Wait()`, goroutine c·ªßa `foo` c√≥ th·ªÉ kh√¥ng k·ªãp ch·∫°y xong tr∆∞·ªõc khi `main` k·∫øt th√∫c, v√¨ Go kh√¥ng ƒë·∫£m b·∫£o goroutine s·∫Ω ho√†n th√†nh.

3. **V·ªÅ `wg.Wait()` v√† `wg.Done()`**:
   - B·∫°n gi·∫£i th√≠ch ƒë√∫ng vai tr√≤ c·ªßa `wg.Wait()` (ch·∫∑n cho ƒë·∫øn khi t·∫•t c·∫£ goroutine ho√†n th√†nh) v√† `wg.Done()` (b√°o r·∫±ng goroutine xong). Nh∆∞ng c√≥ th·ªÉ nh·∫•n m·∫°nh th√™m: n·∫øu thi·∫øu `wg.Done()` trong `foo`, ch∆∞∆°ng tr√¨nh s·∫Ω treo v√¨ `wg.Wait()` ƒë·ª£i m√£i kh√¥ng th·∫•y b·ªô ƒë·∫øm v·ªÅ 0.

4. **V·ªÅ output**:
   - B·∫°n n√≥i ƒë√£ bi·∫øt output, nh∆∞ng c·∫ßn l∆∞u √Ω r·∫±ng th·ª© t·ª± output c·ªßa `foo` v√† `bar` kh√¥ng c·ªë ƒë·ªãnh do t√≠nh ch·∫•t concurrency. ƒêi·ªÅu n√†y ph·ª• thu·ªôc v√†o c√°ch Go scheduler ph√¢n b·ªï th·ªùi gian cho c√°c goroutine.

#### **ƒêi·ªÉm c·∫ßn c·∫£i thi·ªán trong c√°ch hi·ªÉu**:
- C√°ch gi·∫£i th√≠ch c·ªßa b·∫°n h∆°i chung chung ·ªü ph·∫ßn √°nh x·∫° th·ª±c t·∫ø. B·∫°n c√≥ th·ªÉ l√†m r√µ h∆°n b·∫±ng c√°ch li√™n h·ªá v·ªõi m·ªôt t√¨nh hu·ªëng c·ª• th·ªÉ (nh∆∞ v√≠ d·ª• nh√† h√†ng ·ªü tr√™n).
- B·∫°n ch∆∞a ƒë·ªÅ c·∫≠p ƒë·∫øn vai tr√≤ c·ªßa `runtime.NumGoroutine()` trong vi·ªác ki·ªÉm tra s·ªë l∆∞·ª£ng goroutine ƒëang ch·∫°y, ƒëi·ªÅu n√†y gi√∫p debug ho·∫∑c hi·ªÉu tr·∫°ng th√°i ch∆∞∆°ng tr√¨nh.

---

### **5. M·ªôt s·ªë l∆∞u √Ω b·ªï sung**
- **V√¨ sao c·∫ßn `wg.Wait()`?**
  - Trong Go, n·∫øu goroutine `main` k·∫øt th√∫c, to√†n b·ªô ch∆∞∆°ng tr√¨nh s·∫Ω d·ª´ng, b·∫•t k·ªÉ c√°c goroutine kh√°c c√≥ ƒëang ch·∫°y hay kh√¥ng. `wg.Wait()` ƒë·∫£m b·∫£o `main` ƒë·ª£i `foo` ho√†n th√†nh.
  
- **Concurrency vs Parallelism**:
  - Concurrency (ƒë·ªìng th·ªùi) l√† kh·∫£ nƒÉng ch·∫°y nhi·ªÅu t√°c v·ª• xen k·∫Ω, kh√¥ng nh·∫•t thi·∫øt c√πng l√∫c. Trong code n√†y, `foo` v√† `bar` ch·∫°y ƒë·ªìng th·ªùi, nh∆∞ng n·∫øu m√°y ch·ªâ c√≥ 1 CPU, ch√∫ng s·∫Ω xen k·∫Ω (do Go scheduler qu·∫£n l√Ω).
  - Parallelism (song song) x·∫£y ra khi nhi·ªÅu t√°c v·ª• th·ª±c s·ª± ch·∫°y c√πng l√∫c tr√™n nhi·ªÅu CPU. V·ªõi nhi·ªÅu CPU (`runtime.NumCPU()` > 1), `foo` v√† `bar` c√≥ th·ªÉ ch·∫°y song song.

- **Debug v·ªõi `runtime.NumGoroutine()`**:
  - D√≤ng `fmt.Println("NumGoroutine\t", runtime.NumGoroutine())` cho th·∫•y s·ªë goroutine ƒëang ch·∫°y. Ban ƒë·∫ßu l√† 1 (ch·ªâ c√≥ `main`), sau khi g·ªçi `go foo()` l√† 2 (c√≥ `main` v√† `foo`).

---

### **6. Output m·∫´u (c√≥ th·ªÉ thay ƒë·ªïi th·ª© t·ª±)**
D·ª±a tr√™n code, output c√≥ th·ªÉ tr√¥ng nh∆∞ sau (th·ª© t·ª± c·ªßa `foo` v√† `bar` c√≥ th·ªÉ xen k·∫Ω):

```
OS              linux
ARCH            amd64
NumCPU          4
NumGoroutine    1
Version         go1.21.0
bar  0
bar  1
foo  0
foo  1
bar  2
foo  2
...
bar  9
foo  9
NumCPU          4
NumGoroutine    2
```

- **Gi·∫£i th√≠ch**:
  - Th√¥ng tin h·ªá th·ªëng in tr∆∞·ªõc.
  - `foo` v√† `bar` in xen k·∫Ω v√¨ ch·∫°y ƒë·ªìng th·ªùi.
  - Cu·ªëi c√πng, s·ªë CPU v√† s·ªë goroutine ƒë∆∞·ª£c in, v·ªõi 2 goroutine (v√¨ `foo` v·∫´n ƒëang ch·∫°y khi in d√≤ng n√†y).

---

### **7. K·∫øt lu·∫≠n**
- **C√°ch hi·ªÉu c·ªßa b·∫°n**: ƒê√£ n·∫Øm ƒë∆∞·ª£c c√°c kh√°i ni·ªám c∆° b·∫£n v·ªÅ goroutines v√† WaitGroup, nh∆∞ng c√≥ th·ªÉ l√†m r√µ h∆°n b·∫±ng c√°ch li√™n h·ªá v·ªõi v√≠ d·ª• th·ª±c t·∫ø v√† nh·∫•n m·∫°nh c√°c tr∆∞·ªùng h·ª£p l·ªói (nh∆∞ thi·∫øu `wg.Done()`).
- **V√≠ d·ª• th·ª±c t·∫ø**: √Ånh x·∫° v·ªõi t√¨nh hu·ªëng nh∆∞ qu·∫£n l√Ω nh√† h√†ng gi√∫p d·ªÖ h√¨nh dung c√°ch goroutines v√† WaitGroup ph·ªëi h·ª£p.
- **G·ª£i √Ω h·ªçc th√™m**:
  - Th·ª≠ th√™m nhi·ªÅu goroutine (v√≠ d·ª•: g·ªçi `go foo()` v√† `go bar()` c√πng l√∫c, v·ªõi `wg.Add(2)`).
  - T√¨m hi·ªÉu v·ªÅ `runtime.Gosched()` ho·∫∑c channels ƒë·ªÉ qu·∫£n l√Ω concurrency ph·ª©c t·∫°p h∆°n.

N·∫øu b·∫°n mu·ªën m√¨nh gi·∫£i th√≠ch th√™m ph·∫ßn n√†o ho·∫∑c ch·∫°y th·ª≠ code v·ªõi thay ƒë·ªïi, c·ª© n√≥i nh√©, bro! üòé